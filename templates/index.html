<!DOCTYPE html>
<html>
<head>
  <title>Raspberry Pi File Upload</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="disk-space-info">
    üíæ Free: <span id="freeSpace">{{ disk_space.free }}</span> / {{ disk_space.total }}
  </div>

  <h2>üìÅ File Upload & Image Preview</h2>
  <form method="POST" enctype="multipart/form-data" id="uploadForm">
    <div class="drop-zone" id="dropZone">
      <p class="drop-zone-text">üìé Drag & drop, paste (Ctrl+V), or click to browse</p>
      <input type="file" name="file" id="fileInput" style="display: none;">
    </div>
    <input type="submit" value="Upload" id="uploadBtn" disabled>
  </form>
  <hr>
  <h3>Uploaded Files</h3>
  <ul>
    {% for f in files %}
      <li>
        <div class="file-item">
          <div class="file-name">
            <a href="/files/{{ f }}">{{ f }}</a>
          </div>
          {% if f.lower().endswith(('.png', '.jpg', '.jpeg', '.gif', '.bmp', '.webp')) %}
            <img src="/files/{{ f }}" alt="{{ f }}">
          {% endif %}
          <div class="file-actions">
            <a href="/files/{{ f }}" download class="download-btn">‚¨áÔ∏è Download</a>
            <button class="delete-btn" onclick="deleteFile('{{ f }}')">üóëÔ∏è Delete</button>
          </div>
        </div>
      </li>
    {% endfor %}
  </ul>

    <script>
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const dropZone = document.getElementById('dropZone');
    const dropZoneText = dropZone.querySelector('.drop-zone-text');

    // Enable/disable upload button
    fileInput.addEventListener('change', function() {
      uploadBtn.disabled = !this.files.length;
      if (this.files.length) {
        dropZoneText.textContent = '‚úÖ ' + this.files[0].name;
      }
    });

    // Click to browse
    dropZone.addEventListener('click', function() {
      fileInput.click();
    });

    // Drag and drop handlers
    dropZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      this.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length) {
        fileInput.files = files;
        uploadBtn.disabled = false;
        dropZoneText.textContent = '‚úÖ ' + files[0].name;
      }
    });

    // Paste handler for images
    document.addEventListener('paste', function(e) {
      const items = e.clipboardData.items;

      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          e.preventDefault();

          const blob = items[i].getAsFile();
          const timestamp = new Date().getTime();
          const fileName = `pasted-image-${timestamp}.png`;

          // Create a new File object with a proper name
          const file = new File([blob], fileName, { type: blob.type });

          // Create a DataTransfer object to set the file input
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;

          // Update UI
          uploadBtn.disabled = false;
          dropZoneText.textContent = '‚úÖ ' + fileName;

          // Focus on the drop zone to give visual feedback
          dropZone.style.backgroundColor = '#e3f2fd';
          setTimeout(() => {
            dropZone.style.backgroundColor = '';
          }, 500);

          break;
        }
      }
    });

    function deleteFile(filename) {
      if (confirm('Are you sure you want to delete ' + filename + '?')) {
        fetch('/delete/' + encodeURIComponent(filename), {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            location.reload();
          } else {
            alert('Failed to delete: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to delete file');
        });
      }
    }
  </script>
</body>
</html>
